---
title: 11.1. Event Driven Ansible - Events and Facts
weight: 111
sectionnumber: 11
---

In this lab we will have a closer look at events and facts.

### Task 1

* Copy the rulebook from Task 11.3. to new one with the name `debug_event_rulebook.yml`.
* Substitute the `run_playbook` action with a `debug` action.
That debug action should print out all information inside the event.
* Run the rulebook in verbose mode and look at the part of the output generated by the debug action.

{{% details title="Solution Task 1" %}}
```bash
cat debug_event_rulebook.ym`
```
```bash
---
- name: show event json if site down
  hosts: web
  sources:
    - name: check webserver
      ansible.eda.url_check:
        urls:
          - http://<ip-of-node1>:80/
          - http://<ip-of-node2>:80/
        delay: 8
  rules:
    - name: check if site down and rebuild
      condition: event.url_check.status == "down"
      action:
        debug:
          var: event
```

```bash
ansible-rulebook --rulebook debug_event_rulebook.yml -i inventory/hosts -vv
```
```bash
...
2023-06-26 15:04:55,381 - ansible_rulebook.rule_set_runner - INFO - call_action debug
2023-06-26 15:04:55,381 - ansible_rulebook.rule_set_runner - INFO - substitute_variables [{'var': 'event'}] [{'event': {'url_check': {'error_msg': "Cannot connect to host 5.102.146.223:80 ssl:default [Connect call failed ('5.102.146.223', 80)]", 'url': 'http://5.102.146.223/', 'status': 'down'}, 'meta': {'received_at': '2023-06-26T13:04:55.379428Z', 'source': {'name': 'check webserver', 'type': 'ansible.eda.url_check'}, 'uuid': '6710f9a8-c489-4699-a804-8e796855e290'}}}]
2023-06-26 15:04:55,381 - ansible_rulebook.rule_set_runner - INFO - action args: {'var': 'event'}
{'url_check': {'error_msg': "Cannot connect to host 5.102.146.223:80 ssl:default [Connect call failed ('5.102.146.223', 80)]", 'url': 'http://5.102.146.223/', 'status': 'down'}, 'meta': {'received_at': '2023-06-26T13:04:55.379428Z', 'source': {'name': 'check webserver', 'type': 'ansible.eda.url_check'}, 'uuid': '6710f9a8-c489-4699-a804-8e796855e290'}}
...
```
{{% /details %}}

### Task 2

* Rewrite the rulebook `debug_event_rulebook.yml`:
* Use `run_playbook` action to start a playbook named `sos.yml`
* The playbook `sos.yml` should create an unattended sos report labeled with the fully qualified collection name of the source plugin used. Be sure to install the appropriate packages.
* This name of the source plugin should be taken from the json output as a variable.
* Run the rulebook `debug_event_rulebook.yml` and ensure the sos reports on the webservers have the needed label.


{{% alert title="Note" color="primary" %}}
There are good onlinetools to convert [one-line json to multiline json](https://jsonformatter.curiousconcept.com) as well as [json to yaml converters](https://jsonformatter.org/json-to-yaml). Note: The json copied from the output has sometimes single quotes, RFC 8259 demands double quotes. Be sure that your converter fixes this as well. These converters can come in handy for easier reading of the output.
{{% /alert %}}

{{% details title="Solution Task 2" %}}
```bash
cat debug_event_rulebook.yml
```
```bash
---
- name: show event json if site down
  hosts: web
  sources:
    - name: check webserver
      ansible.eda.url_check:
        urls:
          - http://<ip-of-node1>:80/
          - http://<ip-of-node2>:80/
        delay: 8
  rules:
    - name: check if site down and rebuild
      condition: event.url_check.status == "down"
      action:
        run_playbook:
          name: sos.yml
```

```bash
cat sos.yml
```
```bash
---
- hosts: web
  become: true
  tasks:
    - name: install sos package
      ansible.builtin.dnf:
        name:
          - sos
        state: installed

    - name: create a sos report unattended containing no sensitive information
      ansible.builtin.command: "sos report --clean --batch --label {{ ansible_eda.event.meta.source.type }}"
```

```bash
ansible-rulebook --rulebook debug_event_rulebook.yml -i inventory/hosts -vv
```
```bash
...
2023-06-27 11:45:17,300 - ansible_rulebook.builtin - INFO - Calling Ansible runner

PLAY [web] *********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [node1]

TASK [install sos package] *****************************************************
ok: [node1]

TASK [create a sos report unattended containing no sensitive information] ******
ok: [node1] => {
    "msg": "sos report --clean --batch --label ansible.eda.url_check"
}

PLAY RECAP *********************************************************************
node1                      : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
2023-06-27 11:45:20,712 - ansible_rulebook.builtin - DEBUG - Cancel Queue reading task
...
```
{{% /details %}}

### All done?

* [Preview of AAP EDA-Controller GUI](https://www.youtube.com/watch?v=7i_EzHyrKQc&t=178s)
